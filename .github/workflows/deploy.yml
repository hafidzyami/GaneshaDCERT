name: Deploy GaneshaDCERT to VPS

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: DEV

    env:
      PORT: ${{ secrets.PORT }}
      RABBITMQ_URL: ${{ secrets.RABBITMQ_URL }}
      MESSAGE_TTL: ${{ secrets.MESSAGE_TTL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy to Development Server
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST_DEV }}
          username: ${{ secrets.VPS_USER_DEV }}
          key: ${{ secrets.VPS_SSH_KEY_DEV }}
          script: |
            cd /www/ganeshadcert
            git pull origin dev

            # 1. Hentikan semua container yang sedang berjalan
            docker compose down

            # 2. Hapus semua image yang tidak terpakai untuk memastikan build fresh
            docker image prune -af

            # 3. Hapus build cache Docker untuk memastikan build benar-benar fresh
            docker builder prune -af

            # 4. Ambil source code terbaru dari branch main
            git pull origin main
            
            # 5. Buat file .env dari secrets GitHub
            echo "${{ secrets.ENTIRE_ENV_FILE_STAGING }}" > .env

            # 6. Build ulang dengan --no-cache dan --pull untuk memastikan base image juga fresh
            docker compose build --no-cache --pull

            # 7. Jalankan migrasi di container sementara
            docker compose run --rm ganeshadcert-api npx prisma migrate deploy

            # 8. Jalankan semua service di background
            docker compose up -d

            # 9. Cleanup image yang tidak terpakai lagi
            docker image prune -af