name: Deploy GaneshaDCERT to VPS

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: DEV

    env:
      PORT: ${{ secrets.PORT }}
      RABBITMQ_URL: ${{ secrets.RABBITMQ_URL }}
      MESSAGE_TTL: ${{ secrets.MESSAGE_TTL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy to Development Server
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST_DEV }}
          username: ${{ secrets.VPS_USER_DEV }}
          key: ${{ secrets.VPS_SSH_KEY_DEV }}
          script: |
            cd /www/ganeshadcert
            git pull origin dev
            
            if ! docker compose version &> /dev/null; then
              echo "Docker Compose plugin not found, please install it first"
              exit 1
            fi
            
            if ! docker compose ps | grep -q "rabbitmq.*Up"; then
              docker compose up -d
              sleep 10
            fi
            
            npm install
            
            rm -rf dist
            npm run build
            
            pm2 delete ganeshadcert || true
            pm2 startOrRestart pm2.config.js --env dev
            pm2 save
            pm2 startup