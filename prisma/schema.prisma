generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// VC Request
enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestType {
  ISSUANCE
  RENEWAL
  UPDATE
  REVOKE
}

enum PaymentStatus {
  UNPAID
  PAID
  CANCELED
}

enum VCResponseStatus {
  PENDING
  PROCESSING
  CLAIMED
}

enum VPRequestStatus {
  PENDING
  ACCEPT
  DECLINE
}

enum VPVerifyStatus {
  NOT_VERIFIED
  VALID_VERIFICATION
  INVALID_VERIFICATION
}

model VCIssuanceRequest {
  id             String        @id @default(uuid())
  encrypted_body String
  issuer_did     String
  holder_did     String
  status         RequestStatus @default(PENDING)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  vc_id          String?
}

model VCRenewalRequest {
  id             String        @id @default(uuid())
  encrypted_body String
  issuer_did     String
  holder_did     String
  status         RequestStatus @default(PENDING)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  vc_id          String?
}

model VCUpdateRequest {
  id             String        @id @default(uuid())
  encrypted_body String
  issuer_did     String
  holder_did     String
  status         RequestStatus @default(PENDING)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  vc_id          String?
}

model VCRevokeRequest {
  id             String        @id @default(uuid())
  encrypted_body String
  issuer_did     String
  holder_did     String
  status         RequestStatus @default(PENDING)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  vc_id          String?
}

model IssuerActionLog {
  id               String      @id @default(uuid())
  action_type      RequestType // Tipe aksi: ISSUANCE, RENEWAL, UPDATE, or REVOKE
  issuer_did       String
  holder_did       String?     // Opsional, karena revoke mungkin tidak selalu memiliki info ini
  vc_id            String      // VC ID yang terdampak (VC lama untuk UPDATE/RENEW, VC baru untuk ISSUE)
  new_vc_id        String?     // Hanya diisi untuk aksi UPDATE
  transaction_hash String?     // Hash transaksi blockchain
  createdAt        DateTime    @default(now())

  @@index([issuer_did])
  @@index([holder_did])
  @@index([action_type])
}

model VPSharing {
  id           String    @id @default(uuid())
  holder_did   String
  verifier_did String?   // NULL = initiated by holder, NOT NULL = initiated by verifier
  VP           String
  is_barcode   Boolean   @default(false)
  hasClaim     Boolean   @default(false) // Track if VP has been claimed by verifier
  createdAt    DateTime  @default(now())
  deletedAt    DateTime?

  @@index([verifier_did])
  @@index([hasClaim])
}

model VCResponse {
  id             String      @id @default(uuid())
  order_id       String      @default(uuid())
  request_id     String      @default(uuid())
  request_type   RequestType
  issuer_did     String
  holder_did     String
  encrypted_body String
  status         VCResponseStatus @default(PENDING)
  processing_at  DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @default(now()) @updatedAt
  deletedAt      DateTime?
}

model Order {
  id                String        @id @default(uuid())
  payment_method_id String        @default(uuid())
  payment_payload   Json
  VCs_id            String[]      @default(uuid())
  schemas_id        String[]
  request_type      RequestType
  holder_did        String
  issuer_did        String
  payment_status    PaymentStatus @default(UNPAID)
  product_fee       Decimal
  service_fee       Decimal
  total_fee         Decimal
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?
}

model PaymentMethod {
  id               String    @id @default(uuid())
  type             String
  group            String
  name             String
  bank_code        String
  sender_bank_type String
  description      String
  deadline         Int
  icon             String
  availability     Boolean   @default(false)
  fee_fixed        Decimal
  fee_percent      Decimal
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
}

model InstitutionRegistration {
  id         String        @id @default(uuid())
  email      String        @unique
  name       String
  phone      String
  country    String
  website    String
  address    String
  status     RequestStatus @default(PENDING)
  approvedBy String?
  approvedAt DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  magicLinks MagicLink[]
}

model VCSchema {
  id          String   @default(uuid())
  version     Int      @default(1)
  name        String
  schema      Json
  issuer_did  String
  issuer_name String?
  image_link  String?
  expired_in  Int?     // Expiration in years (0 = lifetime, null = not set)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@id([id, version])
  @@index([id])
  @@index([version])
  @@index([isActive])
}

model MagicLink {
  id            String                  @id @default(uuid())
  institutionId String
  token         String                  @unique
  expiresAt     DateTime
  used          Boolean                 @default(false)
  usedAt        DateTime?
  createdAt     DateTime                @default(now())
  institution   InstitutionRegistration @relation(fields: [institutionId], references: [id])

  @@index([token])
  @@index([institutionId])
}

model VPRequest {
  id                    String          @id @default(uuid())
  holder_did            String
  verifier_did          String
  verifier_name         String
  purpose               String
  status                VPRequestStatus @default(PENDING)
  requested_credentials Json            // [{schema_id, schema_name, schema_version}] - What verifier requests
  credentials           Json?           // [{schema_id, schema_name, schema_version}] - What holder actually provides
  vp_id                 String?         // NULL for DECLINE, has value for ACCEPT
  verify_status         VPVerifyStatus  @default(NOT_VERIFIED)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([holder_did])
  @@index([verifier_did])
  @@index([status])
  @@index([vp_id])
}

model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PushToken {
  id         String   @id @default(uuid())
  holder_did String
  token      String   @unique
  deviceInfo Json?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([holder_did])
  @@index([token])
}

model Institution {
  id        String   @id @default(uuid())
  did       String   @unique
  email     String   @unique
  name      String
  phone     String
  country   String
  website   String
  address   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VCinitiatedByIssuer {
  id             String           @id @default(uuid())
  request_type   RequestType
  issuer_did     String
  holder_did     String
  encrypted_body String
  status         VCResponseStatus @default(PENDING)
  processing_at  DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
}

model IssuerVCData {
  id             String   @id @default(uuid())
  issuer_did     String
  holder_did     String?
  vc_id          String?
  encrypted_body String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([issuer_did])
  @@index([holder_did])
  @@index([vc_id])
}